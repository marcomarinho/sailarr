services:
  # ============================================
  # PLEX - Media Server
  # ============================================
  plex:
    image: plexinc/pms-docker:latest
    container_name: plex
    restart: unless-stopped
    environment:
      PLEX_UID: ${PUID:-1000}
      PLEX_GID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      PLEX_CLAIM: ${PLEX_CLAIM:-}
    ports:
      - "32400:32400/tcp" # Plex Web UI
      - "1900:1900/udp" # DLNA
      - "32410:32410/udp" # GDM Network Discovery
      - "32412:32412/udp" # GDM Network Discovery
      - "32413:32413/udp" # GDM Network Discovery
      - "32414:32414/udp" # GDM Network Discovery
      - "32469:32469/tcp" # Plex DLNA Server
      - "8324:8324/tcp" # Plex for Roku
    devices:
      - /dev/dri:/dev/dri # Hardware transcoding (Intel/AMD)
    volumes:
      - ./configs/plex:/config
      #- ./data/plex:/data
      - ./data/local/transcodes/plex:/transcode
      # - ./data/remote/realdebrid:/data/remote/realdebrid:ro # Replaced by Riven mount
      #- ./data/riven/mount:/data/riven:rslave # Riven Mount
      - /mnt/riven:/mount:rslave,z
      #- /mnt:/mnt
      - /dev/shm:/dev/shm
    depends_on:
      - riven
      # - rclone
    networks:
      - mediacenter

  # ============================================
  # VPN - Gluetun (NordVPN)
  # ============================================
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "8888:8888/tcp" # HTTP proxy
      - "8388:8388/tcp" # Shadowsocks
      - "8388:8388/udp" # Shadowsocks
      - "9696:9696" # Prowlarr
      - "8191:8191" # Flaresolverr
    volumes:
      - ./configs/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER:-nordvpn}
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      #- OPENVPN_USER=${VPN_USER}
      #- OPENVPN_PASSWORD=${VPN_PASSWORD}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Switzerland}
      - TZ=${TZ:-America/New_York}
    restart: unless-stopped
    networks:
      - mediacenter

  # ============================================
  # PROWLARR - Indexer Manager
  # ============================================
  prowlarr:
    image: ghcr.io/hotio/prowlarr:release
    container_name: prowlarr
    restart: unless-stopped
    network_mode: service:gluetun
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
    volumes:
      - ./configs/prowlarr:/config
      - /mnt:/mnt
    depends_on:
      gluetun:
        condition: service_healthy

  # ============================================
  # FLARESOLVERR - Cloudflare Proxy
  # ============================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    network_mode: service:gluetun
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/New_York}

  # ============================================
  # OVERSEERR - Request Management System
  # ============================================
  overseerr:
    image: ghcr.io/seerr-team/seerr:develop
    init: true
    container_name: overseerr
    restart: unless-stopped
    environment:
      LOG_LEVEL: debug
      TZ: ${TZ:-America/New_York}
    ports:
      - "5055:5055"
    volumes:
      - ./configs/overseerr:/app/config
    depends_on:
      - plex
    networks:
      - mediacenter

  # ============================================
  # RIVEN - Media Management
  # ============================================
  riven:
    image: spoked/riven:dev
    container_name: riven
    restart: unless-stopped
    ports:
      - "8080:8080"
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      # Database
      - RIVEN_FORCE_ENV=true
      - RIVEN_DATABASE_HOST=postgresql+psycopg2://postgres:postgres@riven-db/riven
      # VFS Configuration
      - RIVEN_FILESYSTEM_MOUNT_PATH=/mount
      - RIVEN_FILESYSTEM_SEPARATE_ANIME_DIRS=false
      - RIVEN_FILESYSTEM_CACHE_DIR=/dev/shm/riven-cache
      - RIVEN_FILESYSTEM_CACHE_MAX_SIZE_MB=10240
      - RIVEN_FILESYSTEM_CACHE_EVICTION=LRU
      - RIVEN_FILESYSTEM_CACHE_TTL_SECONDS=7200
      - RIVEN_FILESYSTEM_CACHE_METRICS=true
      - RIVEN_FILESYSTEM_CHUNK_SIZE_MB=8
      - RIVEN_FILESYSTEM_FETCH_AHEAD_CHUNKS=4
      # Updaters
      - RIVEN_UPDATER_INTERVAL=120
      - RIVEN_LIBRARY_PATH=/mount
      # Downloaders
      - RIVEN_DOWNLOADERS_REAL_DEBRID_ENABLED=true
      - RIVEN_DOWNLOADERS_REAL_DEBRID_API_KEY=${REALDEBRID_API_KEY}
      # Scrapers
      - RIVEN_SCRAPERS_TORRENTIO_ENABLED=true
      # Content Services
      - RIVEN_CONTENT_OVERSEERR_ENABLED=true
      - RIVEN_CONTENT_OVERSEERR_URL=http://overseerr:5055
      - RIVEN_CONTENT_OVERSEERR_API_KEY=${OVERSEERR_API_KEY} # Needs to be set in .env or manually
      # Plex
      - RIVEN_PLEX_ENABLED=true
      - RIVEN_PLEX_URL=http://plex:32400
      - RIVEN_PLEX_TOKEN=${PLEX_TOKEN}
    healthcheck:
      test: curl -s http://localhost:8080 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 10
    volumes:
      - ./configs/riven/data:/riven/data
      - /mnt/riven:/mount:rshared,z
    depends_on:
      riven-db:
        condition: service_healthy
      gluetun:
        condition: service_healthy
    networks:
      - mediacenter

  riven-frontend:
    image: spoked/riven-frontend:dev
    container_name: riven-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - ORIGIN=http://192.168.1.100:3000 # Change to your domain if needed
      - DATABASE_URL=/riven/config/auth.db
      - BACKEND_URL=http://192.168.1.100:8080
      - BACKEND_API_KEY=${BACKEND_API_KEY}
    depends_on:
      riven:
        condition: service_healthy
    volumes:
      - ./configs/riven/frontend:/riven/config
    networks:
      - mediacenter

  riven-db:
    image: postgres:17-alpine
    container_name: riven-db
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=riven
    volumes:
      - ./configs/riven/db:/var/lib/postgresql/data/pgdata
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mediacenter

networks:
  mediacenter:
    name: mediacenter
    driver: bridge
