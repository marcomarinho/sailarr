version: '3.8'

services:
  # ============================================
  # ZURG - Real-Debrid WebDAV Server (DISABLED FOR RIVEN)
  # ============================================
  # zurg:
  #   image: ghcr.io/debridmediamanager/zurg-testing:v0.9.3-final
  #   container_name: zurg
  #   restart: unless-stopped
  #   healthcheck:
  #     test: curl -f localhost:9999/dav/version.txt || exit 1
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   ports:
  #     - "9999:9999"
  #   volumes:
  #     - ./configs/zurg/config.yml:/app/config.yml
  #     - ./configs/zurg/data:/app/data
  #   networks:
  #     - mediacenter

  # ============================================
  # RCLONE - Mount Zurg as filesystem (DISABLED FOR RIVEN)
  # ============================================
  # rclone:
  #   image: rclone/rclone:latest
  #   container_name: rclone
  #   restart: unless-stopped
  #   environment:
  #     TZ: ${TZ:-America/New_York}
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #   volumes:
  #     - ./data/remote/realdebrid:/data:rshared
  #     - ./configs/zurg/rclone.conf:/config/rclone/rclone.conf:ro
  #     - /mnt:/mnt
  #   cap_add:
  #     - SYS_ADMIN
  #   security_opt:
  #     - apparmor:unconfined
  #   devices:
  #     - /dev/fuse:/dev/fuse:rwm
  #   depends_on:
  #     zurg:
  #       condition: service_healthy
  #       restart: true
  #   command: "mount zurg: /data --allow-non-empty --allow-other --vfs-cache-mode full --uid=${PUID:-1000} --gid=${PGID:-1000} --umask=002 --dir-cache-time 10s --vfs-cache-max-age 1h --vfs-cache-max-size 10G --vfs-cache-poll-interval 1m --vfs-read-chunk-size 8M --vfs-read-chunk-size-limit off --vfs-read-ahead 12M --buffer-size 100M --vfs-fast-fingerprint"
  #   networks:
  #     - mediacenter

  # ============================================
  # PLEX - Media Server
  # ============================================
  plex:
    image: plexinc/pms-docker:latest
    container_name: plex
    restart: unless-stopped
    environment:
      PLEX_UID: ${PUID:-1000}
      PLEX_GID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      PLEX_CLAIM: ${PLEX_CLAIM:-}
    ports:
      - "32400:32400/tcp" # Plex Web UI
      - "1900:1900/udp" # DLNA
      - "32410:32410/udp" # GDM Network Discovery
      - "32412:32412/udp" # GDM Network Discovery
      - "32413:32413/udp" # GDM Network Discovery
      - "32414:32414/udp" # GDM Network Discovery
      - "32469:32469/tcp" # Plex DLNA Server
      - "8324:8324/tcp" # Plex for Roku
    devices:
      - /dev/dri:/dev/dri # Hardware transcoding (Intel/AMD)
    volumes:
      - ./configs/plex:/config
      - ./data/plex:/data
      - ./data/local/transcodes/plex:/transcode
      # - ./data/remote/realdebrid:/data/remote/realdebrid:ro # Replaced by Riven mount
      #- ./data/riven/mount:/data/riven:rslave # Riven Mount
      - /mnt/riven:/mount:rslave,z
      - /mnt:/mnt
      - /dev/shm:/dev/shm
    depends_on:
      - riven
      # - rclone
    networks:
      - mediacenter

  # ============================================
  # VPN - Gluetun (NordVPN)
  # ============================================
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "8888:8888/tcp" # HTTP proxy
      - "8388:8388/tcp" # Shadowsocks
      - "8388:8388/udp" # Shadowsocks
      - "9696:9696" # Prowlarr
      - "8080:8080" # Riven
    volumes:
      - ./configs/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER:-nordvpn}
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      #- OPENVPN_USER=${VPN_USER}
      #- OPENVPN_PASSWORD=${VPN_PASSWORD}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Switzerland}
      - TZ=${TZ:-America/New_York}
    restart: unless-stopped
    networks:
      - mediacenter

  # ============================================
  # PROWLARR - Indexer Manager
  # ============================================
  prowlarr:
    image: ghcr.io/hotio/prowlarr:release
    container_name: prowlarr
    restart: unless-stopped
    network_mode: service:gluetun
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
    volumes:
      - ./configs/prowlarr:/config
      - /mnt:/mnt
    depends_on:
      gluetun:
        condition: service_healthy

  # ============================================
  # RADARR - Movie Management (DISABLED FOR RIVEN)
  # ============================================
  # radarr:
  #   image: ghcr.io/hotio/radarr:release
  #   container_name: radarr
  #   restart: unless-stopped
  #   environment:
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #     TZ: ${TZ:-America/New_York}
  #   ports:
  #     - "7878:7878"
  #   volumes:
  #     - ./configs/radarr:/config
  #     - ./data/plex:/data/plex
  #     - ./data/symlinks/radarr:/data/symlinks/radarr
  #     - ./data/remote/realdebrid:/data/remote/realdebrid:ro
  #     - /mnt:/mnt
  #   depends_on:
  #     - rclone
  #   networks:
  #     - mediacenter

  # ============================================
  # SONARR - TV Show Management (DISABLED FOR RIVEN)
  # ============================================
  # sonarr:
  #   image: ghcr.io/hotio/sonarr:release
  #   container_name: sonarr
  #   restart: unless-stopped
  #   environment:
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #     TZ: ${TZ:-America/New_York}
  #   ports:
  #     - "8989:8989"
  #   volumes:
  #     - ./configs/sonarr:/config
  #     - ./data/plex:/data/plex
  #     - ./data/symlinks/sonarr:/data/symlinks/sonarr
  #     - ./data/remote/realdebrid:/data/remote/realdebrid:ro
  #     - /mnt:/mnt
  #   depends_on:
  #     - rclone
  #   networks:
  #     - mediacenter

  # ============================================
  # BLACKHOLE - Torrent Downloader for Debrid (DISABLED FOR RIVEN)
  # ============================================
  # blackhole:
  #   image: ghcr.io/westsurname/scripts/blackhole:latest
  #   container_name: blackhole
  #   restart: unless-stopped
  #   user: "${PUID:-1000}:${PGID:-1000}"
  #   environment:
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #     UMASK: "002"
  #     PYTHONUNBUFFERED: "1"
  #     TZ: ${TZ:-America/New_York}
  #     # Blackhole specific
  #     BLACKHOLE_BASE_WATCH_PATH: /data/symlinks
  #     BLACKHOLE_RADARR_PATH: radarr
  #     BLACKHOLE_SONARR_PATH: sonarr
  #     BLACKHOLE_FAIL_IF_NOT_CACHED: "true"
  #     BLACKHOLE_RD_MOUNT_REFRESH_SECONDS: 200
  #     BLACKHOLE_WAIT_FOR_TORRENT_TIMEOUT: 300
  #     BLACKHOLE_HISTORY_PAGE_SIZE: 500
  #     # Real-Debrid
  #     REALDEBRID_ENABLED: "true"
  #     REALDEBRID_HOST: "https://api.real-debrid.com/rest/1.0/"
  #     REALDEBRID_API_KEY: ${REALDEBRID_API_KEY}
  #     REALDEBRID_MOUNT_TORRENTS_PATH: "/data/remote/realdebrid/__all__"
  #     # Radarr
  #     RADARR_HOST: http://radarr:7878
  #     RADARR_API_KEY: ${RADARR_API_KEY:-}
  #     RADARR_ROOT_FOLDER: "/data/plex/Movies"
  #     # Sonarr
  #     SONARR_HOST: http://sonarr:8989
  #     SONARR_API_KEY: ${SONARR_API_KEY:-}
  #     SONARR_ROOT_FOLDER: "/data/plex/TV"
  #     # Plex (Required to prevent script crash)
  #     PLEX_SERVER_HOST: http://plex:32400
  #     PLEX_SERVER_API_KEY: ${PLEX_TOKEN:-}
  #     PLEX_SERVER_MOVIE_LIBRARY_ID: "0"
  #     PLEX_SERVER_TV_SHOW_LIBRARY_ID: "0"
  #   volumes:
  #     - ./data/remote/realdebrid:/data/remote/realdebrid:ro
  #     - ./data/symlinks:/data/symlinks
  #     - ./configs/blackhole/logs:/app/logs
  #     - ./scripts:/scripts:ro
  #     - /mnt:/mnt
  #   depends_on:
  #     - rclone
  #     - radarr
  #     - sonarr
  #   networks:
  #     - mediacenter

  # ============================================
  # BAZARR - Subtitle Management (DISABLED FOR RIVEN)
  # ============================================
  # bazarr:
  #   image: ghcr.io/hotio/bazarr:release
  #   container_name: bazarr
  #   restart: unless-stopped
  #   environment:
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #     TZ: ${TZ:-America/New_York}
  #   ports:
  #     - "6767:6767"
  #   volumes:
  #     - ./configs/bazarr:/config
  #     - ./data/plex:/data/plex
  #     - ./data/remote/realdebrid:/data/remote/realdebrid:ro
  #     - /mnt:/mnt
  #   depends_on:
  #     - radarr
  #     - sonarr
  #   networks:
  #     - mediacenter

  # ============================================
  # RECYCLARR - TRaSH Guides Sync (DISABLED FOR RIVEN)
  # ============================================
  # recyclarr:
  #   image: ghcr.io/recyclarr/recyclarr
  #   container_name: recyclarr
  #   restart: unless-stopped
  #   user: "${PUID:-1000}:${PGID:-1000}"
  #   environment:
  #     TZ: ${TZ:-America/New_York}
  #   volumes:
  #     - ./configs/recyclarr:/config
  #   depends_on:
  #     - radarr
  #     - sonarr
  #   networks:
  #     - mediacenter

  # ============================================
  # AUTOSCAN - Automatic Plex Library Scanner (DISABLED FOR RIVEN)
  # ============================================
  # autoscan:
  #   image: saltydk/autoscan:latest
  #   container_name: autoscan
  #   restart: unless-stopped
  #   environment:
  #     PUID: ${PUID:-1000}
  #     PGID: ${PGID:-1000}
  #     TZ: ${TZ:-America/New_York}
  #   ports:
  #     - "3030:3030"
  #   volumes:
  #     - ./configs/autoscan:/config
  #     - ./data/plex:/data/plex:ro
  #     - /mnt:/mnt
  #   depends_on:
  #     - plex
  #     - radarr
  #     - sonarr
  #   networks:
  #     - mediacenter

  # ============================================
  # OVERSEERR - Request Management System
  # ============================================
  overseerr:
    image: seerr/seerr:develop
    container_name: overseerr
    restart: unless-stopped
    environment:
      LOG_LEVEL: debug
      TZ: ${TZ:-America/New_York}
    ports:
      - "5055:5055"
    volumes:
      - ./configs/overseerr:/app/config
    depends_on:
      - plex
    networks:
      - mediacenter

  # ============================================
  # RIVEN - Media Management
  # ============================================
  riven:
    image: spoked/riven:dev
    container_name: riven
    restart: unless-stopped
    ports:
      - "8080:8080"
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      # Database
      - RIVEN_FORCE_ENV=true
      - RIVEN_DATABASE_HOST=postgresql+psycopg2://postgres:postgres@riven-db/riven
      # VFS Configuration
      - RIVEN_FILESYSTEM_MOUNT_PATH=/mount
      - RIVEN_FILESYSTEM_SEPARATE_ANIME_DIRS=false
      - RIVEN_FILESYSTEM_CACHE_DIR=/dev/shm/riven-cache
      - RIVEN_FILESYSTEM_CACHE_MAX_SIZE_MB=10240
      - RIVEN_FILESYSTEM_CACHE_EVICTION=LRU
      - RIVEN_FILESYSTEM_CACHE_TTL_SECONDS=7200
      - RIVEN_FILESYSTEM_CACHE_METRICS=true
      - RIVEN_FILESYSTEM_CHUNK_SIZE_MB=8
      - RIVEN_FILESYSTEM_FETCH_AHEAD_CHUNKS=4
      # Updaters
      - RIVEN_UPDATER_INTERVAL=120
      - RIVEN_LIBRARY_PATH=/mount
      # Downloaders
      - RIVEN_DOWNLOADERS_REAL_DEBRID_ENABLED=true
      - RIVEN_DOWNLOADERS_REAL_DEBRID_API_KEY=${REALDEBRID_API_KEY}
      # Scrapers
      - RIVEN_SCRAPERS_TORRENTIO_ENABLED=true
      # Content Services
      - RIVEN_CONTENT_OVERSEERR_ENABLED=true
      - RIVEN_CONTENT_OVERSEERR_URL=http://overseerr:5055
      - RIVEN_CONTENT_OVERSEERR_API_KEY=${OVERSEERR_API_KEY} # Needs to be set in .env or manually
      # Plex
      - RIVEN_PLEX_ENABLED=true
      - RIVEN_PLEX_URL=http://plex:32400
      - RIVEN_PLEX_TOKEN=${PLEX_TOKEN}
    healthcheck:
      test: curl -s http://localhost:8080 >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 10
    volumes:
      - ./configs/riven/data:/riven/data
      - /mnt/riven:/mount:rshared,z
    depends_on:
      riven-db:
        condition: service_healthy
      gluetun:
        condition: service_healthy
    networks:
      - mediacenter
  riven-frontend:
    image: spoked/riven-frontend:dev
    container_name: riven-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - ORIGIN=http://192.168.1.100:3000 # Change to your domain if needed
      - DATABASE_URL=/riven/config/auth.db
      - BACKEND_URL=http://riven:8080
      - BACKEND_API_KEY=${BACKEND_API_KEY}
    depends_on:
      riven:
        condition: service_healthy
    volumes:
      - ./configs/riven/frontend:/riven/config
    networks:
      - mediacenter

  riven-db:
    image: postgres:17-alpine
    container_name: riven-db
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=riven
    volumes:
      - ./configs/riven/db:/var/lib/postgresql/data/pgdata
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mediacenter

networks:
  mediacenter:
    name: mediacenter
    driver: bridge
